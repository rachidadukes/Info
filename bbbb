using Microsoft.Data.Sqlite;
using System;
using System.IO;
using System.Text;

public static class SqliteLogCopier
{
    public static bool CopyTables(
        string sourceDbPath,
        string destinationDbPath,
        out string errorMessage,
        params string[] tableNames)
    {
        errorMessage = string.Empty;

        try
        {
            if (!File.Exists(sourceDbPath))
                throw new FileNotFoundException("Source DB not found.", sourceDbPath);

            if (!File.Exists(destinationDbPath))
                throw new FileNotFoundException("Destination DB not found.", destinationDbPath);

            if (tableNames == null || tableNames.Length == 0)
                throw new ArgumentException("You must specify at least one table name.", nameof(tableNames));

            // IMPORTANT: close any pooled SQLite connections from this process
            SqliteConnection.ClearAllPools();

            var destConnString = new SqliteConnectionStringBuilder
            {
                DataSource = destinationDbPath
            }.ToString();

            using var connection = new SqliteConnection(destConnString);
            connection.DefaultTimeout = 10; // seconds
            connection.Open();

            // Wait up to 5 seconds if another process temporarily holds a lock
            using (var pragmaCmd = connection.CreateCommand())
            {
                pragmaCmd.CommandText = "PRAGMA busy_timeout = 5000;";
                pragmaCmd.ExecuteNonQuery();
            }

            using var transaction = connection.BeginTransaction();
            using var cmd = connection.CreateCommand();
            cmd.Transaction = transaction;

            var sb = new StringBuilder();
            sb.AppendLine("ATTACH DATABASE $srcPath AS SrcDb;");

            foreach (var table in tableNames)
            {
                var safeTable = table.Replace("\"", "\"\"");

                sb.AppendLine($@"DELETE FROM ""{safeTable}"";");
                sb.AppendLine($@"INSERT INTO ""{safeTable}"" SELECT * FROM SrcDb.""{safeTable}"";");
            }

            sb.AppendLine("DETACH DATABASE SrcDb;");

            cmd.CommandText = sb.ToString();
            cmd.Parameters.AddWithValue("$srcPath", sourceDbPath);

            cmd.ExecuteNonQuery();
            transaction.Commit();

            return true;
        }
        catch (FileNotFoundException ex)
        {
            errorMessage = $"File not found: {ex.FileName}";
            return false;
        }
        catch (SqliteException ex)
        {
            errorMessage = $"SQLite error while copying tables: {ex.Message}";
            return false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error while copying tables: {ex.Message}";
            return false;
        }
    }
}


===========================


private async void btnCopyLogs_Click(object sender, RoutedEventArgs e)
{
    Mouse.OverrideCursor = Cursors.Wait;
    btnCopyLogs.IsEnabled = false;

    try
    {
        SqliteConnection.ClearAllPools(); // extra safety

        var result = await Task.Run(() =>
        {
            bool ok = SqliteLogCopier.CopyTables(
                @"C:\Path\SQLiteLogs.db",
                @"C:\Path\SQLiteLogsTransactions.db",
                out string error,
                "LogDetails",
                "RequestResponse");

            return (ok, error);
        });

        if (!result.ok)
            MessageBox.Show(result.error, "Copy Failed");
        else
            MessageBox.Show("Copy completed successfully.");
    }
    finally
    {
        Mouse.OverrideCursor = null;
        btnCopyLogs.IsEnabled = true;
    }
}

