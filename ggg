using System;
using System.Collections.Specialized;
using Microsoft.Extensions.Configuration;

namespace ApiClientLib;

public static class HostRoutingConfig
{
    // Reads from appsettings.json (root or a "HostRouting" section) + env vars
    public static NameValueCollection GetHostSettings()
    {
        var builder = new ConfigurationBuilder()
            .SetBasePath(AppContext.BaseDirectory)
            .AddJsonFile("appsettings.json", optional: true, reloadOnChange: false)
            .AddEnvironmentVariables();

        var config = builder.Build();

        var nvc = new NameValueCollection();

        // Option A: flat keys at root
        CopyIfPresent(nvc, config, "MessageConverterURL");
        CopyIfPresent(nvc, config, "IgnoreServerCertificateErrors");

        // Option B: if you keep a section (use either style)
        var section = config.GetSection("HostRouting");
        if (section.Exists())
        {
            CopyIfPresent(nvc, section, "MessageConverterURL");
            CopyIfPresent(nvc, section, "IgnoreServerCertificateErrors");
        }

        return nvc;
    }

    private static void CopyIfPresent(NameValueCollection nvc, IConfiguration config, string key)
    {
        var value = config[key];
        if (!string.IsNullOrWhiteSpace(value))
            nvc[key] = value;
    }

    private static void CopyIfPresent(NameValueCollection nvc, IConfigurationSection section, string key)
    {
        var value = section[key];
        if (!string.IsNullOrWhiteSpace(value))
            nvc[key] = value;
    }
}
