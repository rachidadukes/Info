
using System.Net.Http;
using System.Net.Security;
using System.Security.Authentication;
using System.Security.Cryptography.X509Certificates;
using System.Text;

internal class Program
{
    private const string ApiUrl = "https://swydcdvencaej01.nfcu.net/EncoreCore/api/MessageConverter/ConvertMessage";
    private const string ClientCertSubjectName = "LTCC483A490BE4.nfcu.net";
    private const StoreLocation ClientCertStoreLocation = StoreLocation.LocalMachine;
    private const StoreName ClientCertStoreName = StoreName.My;

    private static async Task<int> Main()
    {
        Console.WriteLine("== Certificate & Endpoint Probe ==");

        // 1) Check certificate health
        var (certStatus, cert, certMsg) = FindClientCertificate(
            ClientCertSubjectName, ClientCertStoreName, ClientCertStoreLocation);

        Console.WriteLine($"[Cert] {certStatus}: {certMsg}");
        if (certStatus == ProbeStatus.Error || cert is null)
        {
            Console.WriteLine("‚ùå Certificate not found or invalid.");
            return 2;
        }

        // 2) Test XML REST call using the certificate
        Console.WriteLine("\n== XML API Call Test ==");
        var xmlPayload = @"<ConvertMessageRequest>
  <ClientId>HealthCheck</ClientId>
  <Payload>Test</Payload>
</ConvertMessageRequest>";

        var xmlResult = await PostXmlAsync(ApiUrl, xmlPayload, cert);
        Console.WriteLine($"[Call:XML] {xmlResult.Status}: {xmlResult.Message}");

        // 3) Summary
        Console.WriteLine("\n== Summary ==");
        Console.WriteLine($"Certificate: {cert.Subject}");
        Console.WriteLine($"Valid: {cert.NotBefore:u} - {cert.NotAfter:u}");
        Console.WriteLine($"Health: {certStatus}");
        Console.WriteLine($"XML Call Result: {xmlResult.Status}");

        return 0;
    }

    // ----------------------------------------------------------
    //  Certificate validation logic (kept from your existing code)
    // ----------------------------------------------------------
    private static (ProbeStatus Status, X509Certificate2? Cert, string Message) FindClientCertificate(
        string subjectOrCn, StoreName storeName, StoreLocation storeLocation)
    {
        try
        {
            using var store = new X509Store(storeName, storeLocation);
            store.Open(OpenFlags.ReadOnly | OpenFlags.OpenExistingOnly);

            var matches = store.Certificates
                .Find(X509FindType.FindBySubjectDistinguishedName, subjectOrCn, validOnly: false);
            if (matches.Count == 0)
                matches = store.Certificates
                    .Find(X509FindType.FindBySubjectName, subjectOrCn, validOnly: false);

            if (matches.Count == 0)
                return (ProbeStatus.Error, null, $"Not found in {storeLocation}/{storeName} by subject '{subjectOrCn}'.");

            X509Certificate2? best = null;
            foreach (var c in matches)
            {
                if (!c.HasPrivateKey) continue;
                if (best == null || c.NotBefore > best.NotBefore) best = c;
            }
            best ??= matches[0];

            var validity =
                best.NotBefore > DateTime.UtcNow ? "NotYetValid" :
                best.NotAfter < DateTime.UtcNow ? "Expired" : "Valid";

            var hasPk = best.HasPrivateKey ? "Yes" : "No";
            var status = validity == "Valid" ? ProbeStatus.Success : ProbeStatus.Error;

            return (status, best,
                $"Thumbprint={best.Thumbprint}; Subject={best.Subject}; HasPrivateKey={hasPk}; Validity={validity}; " +
                $"NotBefore={best.NotBefore:u}; NotAfter={best.NotAfter:u}");
        }
        catch (Exception ex)
        {
            return (ProbeStatus.Error, null, $"Exception reading store: {ex.Message}");
        }
    }

    // ----------------------------------------------------------
    //  XML POST request logic (new addition)
    // ----------------------------------------------------------
    private static async Task<ProbeResult> PostXmlAsync(string url, string xml, X509Certificate2? clientCertificate)
    {
        try
        {
            var handler = new HttpClientHandler
            {
                SslProtocols = SslProtocols.Tls12,
                CheckCertificateRevocationList = true,
                ServerCertificateCustomValidationCallback = (req, cert, chain, errors) =>
                {
                    Console.WriteLine($"[TLS] Errors={errors}");
                    return errors == SslPolicyErrors.None;
                }
            };

            if (clientCertificate != null)
            {
                handler.ClientCertificates.Add(clientCertificate);
                handler.ClientCertificateOptions = ClientCertificateOption.Manual;
            }

            using var client = new HttpClient(handler);
            var content = new StringContent(xml, Encoding.UTF8, "application/xml");
            content.Headers.ContentType.MediaType = "text/xml"; // Some servers require text/xml
            var req = new HttpRequestMessage(HttpMethod.Post, url) { Content = content };

            var response = await client.SendAsync(req);
            var body = await response.Content.ReadAsStringAsync();
            if (body.Length > 500) body = body[..500] + "...";

            return new ProbeResult(
                response.IsSuccessStatusCode ? ProbeStatus.Success : ProbeStatus.HttpError,
                $"HTTP {(int)response.StatusCode} {response.StatusCode}; Body={body}");
        }
        catch (HttpRequestException hre)
        {
            return new ProbeResult(ProbeStatus.NetworkError, $"HttpRequestException: {hre.Message}");
        }
        catch (AuthenticationException ae)
        {
            return new ProbeResult(ProbeStatus.HandshakeFailed, $"TLS Handshake failed: {ae.Message}");
        }
        catch (Exception ex)
        {
            return new ProbeResult(ProbeStatus.Error, ex.Message);
        }
    }
