if (!resp.IsSuccessStatusCode)
{
    var headers = string.Join("\n", resp.Headers.Select(h => $"{h.Key}: {string.Join(", ", h.Value)}"));
    var contentHeaders = string.Join("\n", resp.Content.Headers.Select(h => $"{h.Key}: {string.Join(", ", h.Value)}"));

    response =
$@"HTTP {(int)resp.StatusCode} {resp.ReasonPhrase}
--- Response Headers ---
{headers}
--- Content Headers ---
{contentHeaders}
--- Body ---
{response}";
}
