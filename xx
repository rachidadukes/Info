Option Strict On
Option Explicit On

Imports System.Configuration
Imports System.Security.Cryptography.X509Certificates

Namespace Security

    Public NotInheritable Class CertificateLoader
        Private Sub New()
        End Sub

        ''' <summary>
        ''' Loads a client certificate from the Windows certificate store using AppSettings:
        ''' - ClientCert.SubjectName
        ''' - ClientCert.StoreLocation  (LocalMachine | CurrentUser)
        ''' - ClientCert.StoreName      (My | Root | CA | etc)
        ''' </summary>
        Public Shared Function GetCertificate() As X509Certificate2
            Dim subject As String = ConfigurationManager.AppSettings("ClientCert.SubjectName")
            If String.IsNullOrWhiteSpace(subject) Then
                Throw New ConfigurationErrorsException("Missing appSetting: ClientCert.SubjectName")
            End If

            Dim storeLocStr As String = ConfigurationManager.AppSettings("ClientCert.StoreLocation")
            Dim storeNameStr As String = ConfigurationManager.AppSettings("ClientCert.StoreName")

            Dim storeLoc As StoreLocation = StoreLocation.LocalMachine
            Dim storeName As StoreName = StoreName.My

            If Not String.IsNullOrWhiteSpace(storeLocStr) Then
                [Enum].TryParse(storeLocStr, True, storeLoc)
            End If

            If Not String.IsNullOrWhiteSpace(storeNameStr) Then
                [Enum].TryParse(storeNameStr, True, storeName)
            End If

            Using store As New X509Store(storeName, storeLoc)
                store.Open(OpenFlags.ReadOnly Or OpenFlags.OpenExistingOnly)

                ' FindBySubjectName is a "contains" match, so use a specific subject fragment (e.g., CN=YourName)
                Dim matches As X509Certificate2Collection =
                    store.Certificates.Find(X509FindType.FindBySubjectName, subject, validOnly:=True)

                Dim cert As X509Certificate2 = matches.FindValidClientAuthCertificate()
                If cert Is Nothing Then
                    Throw New InvalidOperationException(
                        $"No valid client-auth certificate found for SubjectName contains '{subject}' in {storeLoc}\{storeName}."
                    )
                End If

                Return cert
            End Using
        End Function

    End Class

End Namespace


=======================================


Option Strict On
Option Explicit On

Imports System.Linq
Imports System.Security.Cryptography
Imports System.Security.Cryptography.X509Certificates

Namespace Security

    Public Module X509Certificate2CollectionExtensions

        ' OID for Enhanced Key Usage: Client Authentication
        Private Const ClientAuthenticationOid As String = "1.3.6.1.5.5.7.3.2"

        ''' <summary>
        ''' Returns the "best" valid certificate:
        ''' - Has private key
        ''' - Is time-valid (NotBefore/NotAfter)
        ''' - Has EKU Client Authentication (1.3.6.1.5.5.7.3.2)
        ''' - Picks newest by NotBefore
        ''' </summary>
        <System.Runtime.CompilerServices.Extension>
        Public Function FindValidClientAuthCertificate(col As X509Certificate2Collection) As X509Certificate2
            If col Is Nothing OrElse col.Count = 0 Then
                Return Nothing
            End If

            Dim now As DateTime = DateTime.Now

            Dim best As X509Certificate2 =
                col.Cast(Of X509Certificate2)().
                    Where(Function(c) c IsNot Nothing).
                    Where(Function(c) c.HasPrivateKey).
                    Where(Function(c) now >= c.NotBefore AndAlso now <= c.NotAfter).
                    Where(Function(c) IsClientAuthenticationCertificate(c)).
                    OrderByDescending(Function(c) c.NotBefore).
                    FirstOrDefault()

            Return best
        End Function

        ''' <summary>
        ''' Checks if certificate contains EKU Client Authentication.
        ''' If EKU extension is missing, returns False (strict).
        ''' </summary>
        <System.Runtime.CompilerServices.Extension>
        Public Function IsClientAuthenticationCertificate(certificate As X509Certificate2) As Boolean
            If certificate Is Nothing Then
                Return False
            End If

            For Each ext As X509Extension In certificate.Extensions
                Dim ekuExt As X509EnhancedKeyUsageExtension = TryCast(ext, X509EnhancedKeyUsageExtension)
                If ekuExt Is Nothing Then Continue For

                For Each oid As Oid In ekuExt.EnhancedKeyUsages
                    If oid IsNot Nothing AndAlso String.Equals(oid.Value, ClientAuthenticationOid, StringComparison.Ordinal) Then
                        Return True
                    End If
                Next
            Next

            Return False
        End Function

    End Module

End Namespace

