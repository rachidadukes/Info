public static void BeautifyResponse(string xml)
{
    if (string.IsNullOrWhiteSpace(xml))
    {
        AnsiConsole.MarkupLine("[red]Empty response[/]");
        return;
    }

    // ✅ Fix 1: Trim non-XML header lines
    int xmlStart = xml.IndexOf('<');
    if (xmlStart > 0)
        xml = xml.Substring(xmlStart).Trim();

    string prettyXml = BeautifyXml(xml);

    // Extract meaningful fields
    string infoMessage = ExtractTagContent(xml, "InfoMessage");
    string statusDesc = ExtractTagContent(xml, "StatusDesc");
    string responseCode = ExtractTagContent(xml, "ResponseCode");

    bool looksError =
        xml.IndexOf("error", StringComparison.OrdinalIgnoreCase) >= 0 ||
        xml.IndexOf("fault", StringComparison.OrdinalIgnoreCase) >= 0 ||
        xml.IndexOf("exception", StringComparison.OrdinalIgnoreCase) >= 0 ||
        responseCode == "3";

    // Output
    AnsiConsole.MarkupLine("[bold red]Response:[/]");
    AnsiConsole.WriteLine();
    AnsiConsole.MarkupLine("[grey]--- Beautified XML ---[/]");
    PrintPreserved(prettyXml, Color.Green);

    if (looksError)
    {
        AnsiConsole.WriteLine();
        AnsiConsole.MarkupLine("[red]--- Detected Error Message ---[/]");
        string finalError = !string.IsNullOrEmpty(infoMessage)
            ? infoMessage
            : !string.IsNullOrEmpty(statusDesc)
                ? statusDesc
                : "Unknown error";

        PrintPreserved(finalError, Color.Red);
    }
}

private static string BeautifyXml(string xml)
{
    try
    {
        // ✅ Fix 2: Skip anything before the root tag
        int start = xml.IndexOf('<');
        if (start > 0)
            xml = xml.Substring(start).Trim();

        var doc = XDocument.Parse(xml, LoadOptions.PreserveWhitespace);
        var sb = new StringBuilder();

        var settings = new XmlWriterSettings
        {
            Indent = true,
            IndentChars = "  ",
            NewLineChars = "\r\n",
            NewLineHandling = NewLineHandling.Replace,
            Encoding = new UTF8Encoding(false),
            OmitXmlDeclaration = false
        };

        using (var writer = XmlWriter.Create(new StringWriter(sb), settings))
            doc.Save(writer);

        return sb.ToString();
    }
    catch
    {
        return xml; // fallback to raw
    }
}
