using System.Net;
using System.Net.Http;
using System.Net.Security;
using System.Security.Cryptography.X509Certificates;

private static HttpClientHandler CreateHandler(
    out SslPolicyErrors lastTlsErrors,
    out X509Certificate2? serverCert)
{
    try
    {
        // Initialize local capture variables
        SslPolicyErrors localTlsErrors = SslPolicyErrors.None;
        X509Certificate2? localServerCert = null;

        var handler = new HttpClientHandler();

        // üß© Optional: enable CRL on Windows only
        if (OperatingSystem.IsWindows())
            handler.CheckCertificateRevocationList = true;

        // üîê Capture TLS details into local variables
        handler.ServerCertificateCustomValidationCallback = (req, cert, chain, errors) =>
        {
            localTlsErrors = errors;

            if (cert != null)
            {
                if (cert is X509Certificate2 cert2)
                {
                    localServerCert = cert2;
                }
                else
                {
                    // no nested try; will throw if invalid
                    localServerCert = new X509Certificate2(cert);
                }
            }

            // ‚ö†Ô∏è TEMP: trust all certs for diagnostics
            return true;
        };

        // ‚öôÔ∏è Standard handler setup
        handler.ClientCertificateOptions = ClientCertificateOption.Manual;
        handler.AllowAutoRedirect = true;
        handler.AutomaticDecompression = DecompressionMethods.None;

        // ‚úÖ Assign captured values to out parameters before returning
        lastTlsErrors = localTlsErrors;
        serverCert = localServerCert;

        return handler;
    }
    catch (PlatformNotSupportedException ex)
    {
        Console.WriteLine($"[CreateHandler] Platform not supported: {ex.Message}");
        lastTlsErrors = SslPolicyErrors.None;
        serverCert = null;
        return new HttpClientHandler();
    }
    catch (CryptographicException ex)
    {
        Console.WriteLine($"[CreateHandler] Certificate error: {ex.Message}");
        lastTlsErrors = SslPolicyErrors.RemoteCertificateChainErrors;
        serverCert = null;
        return new HttpClientHandler();
    }
    catch (HttpRequestException ex)
    {
        Console.WriteLine($"[CreateHandler] HTTP error: {ex.Message}");
        lastTlsErrors = SslPolicyErrors.RemoteCertificateChainErrors;
        serverCert = null;
        return new HttpClientHandler();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"[CreateHandler] Unexpected error: {ex.Message}");
        lastTlsErrors = SslPolicyErrors.None;
        serverCert = null;
        return new HttpClientHandler();
    }
}
