Imports System
Imports System.IO
Imports System.Linq
Imports System.Text
Imports System.Xml
Imports System.Xml.Linq
Imports Spectre.Console

Public NotInheritable Class XmlStringFormatter
    Private Sub New()
    End Sub

    Public Shared Sub BeautifyXmlString(xml As String)
        If String.IsNullOrWhiteSpace(xml) Then
            AnsiConsole.MarkupLine("[red]Empty response[/]")
            Return
        End If

        ' Fix 1: Trim non-XML header lines
        Dim xmlStart As Integer = xml.IndexOf("<"c)
        If xmlStart > 0 Then
            xml = xml.Substring(xmlStart).Trim()
        End If

        Dim prettyXml As String = BeautifyXml(xml)

        ' Extract meaningful fields
        Dim infoMessage As String = ExtractTagContent(xml, "InfoMessage")
        Dim statusDesc As String = ExtractTagContent(xml, "StatusDesc")
        Dim responseCode As String = ExtractTagContent(xml, "ResponseCode")

        Dim looksError As Boolean =
            xml.IndexOf("error", StringComparison.OrdinalIgnoreCase) >= 0 OrElse
            xml.IndexOf("fault", StringComparison.OrdinalIgnoreCase) >= 0 OrElse
            xml.IndexOf("exception", StringComparison.OrdinalIgnoreCase) >= 0 OrElse
            responseCode = "3"

        ' Output
        PrintPreserved(prettyXml, Color.Green)

        If looksError Then
            AnsiConsole.WriteLine()
            AnsiConsole.MarkupLine("[red]--- Detected Error Message ---[/]")

            Dim finalError As String =
                If(Not String.IsNullOrEmpty(infoMessage),
                   infoMessage,
                   If(Not String.IsNullOrEmpty(statusDesc),
                      statusDesc,
                      "Unknown error"))

            PrintPreserved(finalError, Color.Red)
        End If
    End Sub

    Private Shared Function BeautifyXml(xml As String) As String
        Try
            ' Fix 2: Skip anything before the root tag
            Dim start As Integer = xml.IndexOf("<"c)
            If start > 0 Then
                xml = xml.Substring(start).Trim()
            End If

            Dim doc As XDocument = XDocument.Parse(xml, LoadOptions.PreserveWhitespace)
            Dim sb As New StringBuilder()

            Dim settings As New XmlWriterSettings() With {
                .Indent = True,
                .IndentChars = "  ",
                .NewLineChars = vbCrLf,
                .NewLineHandling = NewLineHandling.Replace,
                .Encoding = New UTF8Encoding(False),
                .OmitXmlDeclaration = False
            }

            Using writer As XmlWriter = XmlWriter.Create(New StringWriter(sb), settings)
                doc.Save(writer)
            End Using

            Return sb.ToString()

        Catch
            Return xml ' fallback to raw
        End Try
    End Function

    Private Shared Function ExtractTagContent(xml As String, tag As String) As String
        Try
            Dim doc As XDocument = XDocument.Parse(xml)
            Dim node = doc.Descendants().FirstOrDefault(
                Function(e) e.Name.LocalName.Equals(tag, StringComparison.OrdinalIgnoreCase))

            If node Is Nothing Then Return String.Empty

            Dim value As String = If(node.Value, "").Trim()
            Return value

        Catch
            Return String.Empty
        End Try
    End Function

    Private Shared Sub PrintPreserved(text As String, color As Color)
        Dim block As New Text(text, New Style(foreground:=color))
        AnsiConsole.Write(block)
        AnsiConsole.WriteLine()
    End Sub

End Class
