private static HttpClientHandler CreateHandler(
    out SslPolicyErrors lastTlsErrors,
    out X509Certificate2 serverCert)
{
    // locals to capture inside lambda
    SslPolicyErrors localTlsErrors = SslPolicyErrors.None;
    X509Certificate2 localServerCert = null;

    var handler = new HttpClientHandler();

    handler.ServerCertificateCustomValidationCallback = (sender, cert, chain, errors) =>
    {
        localTlsErrors = errors;

        // Try capture cert details for logging
        try
        {
            localServerCert = new X509Certificate2(cert);
        }
        catch
        {
            // ignore
        }

        return IgnoreCertValidation || errors == SslPolicyErrors.None;
    };

    // assign captured values back to out parameters
    lastTlsErrors = localTlsErrors;
    serverCert = localServerCert;

    return handler;
}
